function showNotice(e){if(e!=0){$("#savedOrder").find(".result").html("Successfully Saved");$("#savedOrder").find(".reference").html("Order no. is "+e)}else{$("#savedOrder").find(".result").html("Saved Locally");$("#savedOrder").find(".reference").html("")}$.mobile.changePage("#savedOrder",{transition:"slide",reverse:false,changeHash:true})}function onSuccess(e){if(e.Name!=undefined){Store.set("user",e,stayloggedin);app.initialize()}else{$.mobile.hidePageLoadingMsg();navigator.notification.alert("Incorrect Login",callBack,"Error");$("#txtUserName").val("");$("#txtPassword").val("")}}function login(){var e=$("#txtUserName").val().trim();var t=$("#txtPassword").val().trim();if(e==""||t==""){navigator.notification.alert("Please Fill The Details Completely",callBackFunc,"Error");return false}$.mobile.loadingMessageTextVisible=true;$.mobile.loadingMessage="Login";$.mobile.loadingMessageTheme="c";$.mobile.showPageLoadingMsg();$.ajax({type:"POST",url:url+"do_login",data:{username:e,password:t},cache:true,dataType:"json",success:onSuccess,error:onerror});return false}function onerror(e){navigator.notification.alert("Error In Your Internet Connection",callBackFunc,"Error");$.mobile.hidePageLoadingMsg();$("#txtUserName").val("");$("#txtPassword").val("")}function callBackFunc(){}var app={initialize:function(){var e=this;if(!Store.isSet("appData."+Store.get("user").Userid)){this.getAppData(app.changePage)}else{this.changePage()}},fetch:function(e){$.getJSON(url+e,function(t){Store.set(e+"."+Store.get("user").Userid,t,0)})},getAppData:function(e){$.mobile.loadingMessage="Customers";$.mobile.showPageLoadingMsg();unBindEvents();var t=Store.get("user").Userid;$.getJSON(url+"customers",{userid:t},function(e){$.each(e,function(e,t){t.order=0});Store.set("customers."+Store.get("user").Userid,e,0)}).done(function(){$.mobile.loadingMessage="Products";$.mobile.showPageLoadingMsg();$.getJSON(url+"products",function(e){Store.set("products."+Store.get("user").Userid,e,0)}).done(function(){var t=Store.get("products."+Store.get("user").Userid);var n=getDistinct(t,"pmCategory");Store.set("category."+Store.get("user").Userid,n,0);$.mobile.loadingMessage="Loading..";bindEvents();$.mobile.showPageLoadingMsg();Store.set("appData."+Store.get("user").Userid,"1",0);e()})})},changePage:function(){$.mobile.changePage("#saleOrderSelectCustomer",{transition:"slide",reverse:false,changeHash:true});var e=Store.get("customers."+Store.get("user").Userid);app.loadPage(e);return false},loadPage:function(e){e=sortByKey(e,"order");var t;var n;var r;var i;$("#ui-results").children(".added").remove();$.each(e,function(e,s){if(e>=10){return false}n=s.smStoreName.split("-");r=s.smStoreName;i=s.smStoreName;if(typeof n[0]!="undefined"){r=$.trim(n[0])}if(typeof n[1]!="undefined"){i=$.trim(n[1])}t=$(".template",$("#ui-results")).clone().removeClass("template");$(".storeName",t).html(r);$(".storeCode",t).html(s.smStoreCode);$(".location",t).html(i);$(".storeId",t).val(s.smId);$(t).addClass("added");$(t).appendTo("#ui-results");$("#ui-results").show()});$(".customer").unbind("tap",orders.selectCustomer);$(".customer").bind("tap",{page:"#saleOrderEntry"},orders.selectCustomer);$.mobile.hidePageLoadingMsg();$("#txtUserName").val("");$("#txtPassword").val("");return false},postData:function(e,t,n){$.mobile.loadingMessageTextVisible=true;$.mobile.loadingMessage="Sending..";$.mobile.showPageLoadingMsg();unBindEvents();var r=[];if(Store.isSet(t+"."+Store.get("user").Userid)){r=Store.get(t+"."+Store.get("user").Userid);Store.clear(t+"."+Store.get("user").Userid)}$.ajax({type:"POST",url:url+t,data:e,cache:false,dataType:"html",success:function(i){e["savedStatus"]="true";e["referenceNo"]=i;e["serialNo"]=r.length+1;r.push(e);Store.set(t+"."+Store.get("user").Userid,r,0);n(i);bindEvents();$.mobile.hidePageLoadingMsg()},error:function(){r=sortByKey(r,"serialNo");e["referenceNo"]=0;e["savedStatus"]="false";var i=getObject(r,"date",e["date"]);if(i){e["serialNo"]=r[i]["serialNo"];r.splice(i,1)}else{if(typeof r[r.length-1]=="undefined")e["serialNo"]=r.length+1;else e["serialNo"]=r[r.length-1]["serialNo"]+1}r.push(e);Store.set(t+"."+Store.get("user").Userid,r,0);n(0);bindEvents();$.mobile.hidePageLoadingMsg()}})}};var orders={pendingOrders:[],products:[],savedOrders:[],viewOrder:function(){editMode=false;var e=$(this).find("input.storeId").val();var t=$(this).find("input.serialNo").val();var n=$(this).find("span.storeName").html();var r=$(this).find("span.location").html();var i=$(this).find("span.storeCode").html();$("#saleOrderEntry").find(".storeId").val(e);$("#saleOrderEntry").find(".storeName").html(n);$("#saleOrderEntry").find(".location").html(r);$("#saleOrderEntry").find(".storeCode").html(i);var s=getObject(Store.get("order."+Store.get("user").Userid),"serialNo",t);orders.savedOrders=Store.get("order."+Store.get("user").Userid)[s];$.mobile.changePage("#saleOrderEntry",{transition:"slide",reverse:true,changeHash:true});return false},selectCustomer:function(){editMode=true;var e=$(this).find("input.storeId").val();var t=$(this).find("strong.storeName").html();var n=$(this).find("span.location").html();var r=$(this).find("span.storeCode").html();var s={storeId:e,storeName:t,location:n,storeCode:r,items:[]};var o=getObject(orders.pendingOrders,"storeId",e);if(!o){orders.pendingOrders.push(s);o=orders.pendingOrders.length-1}for(i in orders.pendingOrders){orders.pendingOrders[i]["selectedOrder"]=false;if(i==o){orders.pendingOrders[i]["selectedOrder"]=true}}$("#saleOrderEntry").find(".storeId").val(e);$("#saleOrderEntry").find(".storeName").html(t);$("#saleOrderEntry").find(".location").html(n);$("#saleOrderEntry").find(".storeCode").html(r);$.mobile.changePage("#saleOrderEntry",{transition:"slide",reverse:true,changeHash:true});return false},removeItem:function(){var e=$(this).parent().find(".productId").val();var t=getObject(orders.pendingOrders,"selectedOrder",true);var n=getObject(orders.pendingOrders[t].items,"productId",e);orders.pendingOrders[t].items.splice(n,1);$("#editItem").popup("close");$.each($("#ui-items").find("li"),function(t){if($(this).find(".productId").val()==e){$(this).remove()}});return false},addProduct:function(){$("#enterProducts").find("#category").val("Category").change();$("#enterProducts").find("#productId").val("");$("#enterProducts").find("#product").val("");$("#enterProducts").find("#quantity").val("");$("#enterProducts").find("#offerquantity").val("");if($(this).hasClass("addproduct")){$.mobile.changePage("#enterProducts",{transition:"slide",reverse:false,changeHash:true})}else{if($(this).parent().find(".productId").val()!==""){var e;var t;var n;var r=$(this).parent().find(".productId").val();if(editMode){e=getObject(orders.pendingOrders,"selectedOrder",true);t=getObject(orders.pendingOrders[e].items,"productId",r);n=orders.pendingOrders[e].items[t]}else{t=getObject(orders.savedOrders.items,"productId",r);n=orders.savedOrders.items[t]}$.mobile.changePage("#enterProducts",{transition:"slide",reverse:true,changeHash:true});$("#enterProducts").find("#category").val(n.category).change();$("#enterProducts").find("#productId").val(n.productId);$("#enterProducts").find("#product").val(n.productName);$("#enterProducts").find("#quantity").val(n.quantity);$("#enterProducts").find("#offerquantity").val(n.offerquantity)}else{$.mobile.changePage("#enterProducts",{transition:"slide",reverse:false,changeHash:true})}}return false},validateItem:function(){if($("#category option:selected").text()=="Category"){throw"Invalid category";return false}if($.trim($("#product").val())==""){throw"Invalid product";return false}if($("#productId").val()==""&&$.trim($("#product").val())==""){throw"Product not selected";return false}if($.trim($("#quantity").val())==""||isNaN($.trim($("#quantity").val()))){$("#quantity").val("");throw"Product not selected";return false}if(isNaN($.trim($("#offerquantity").val()))){$("#offerquantity").val("");throw"Invalid offer quantity";return false}},addItem:function(){var e=getObject(orders.pendingOrders,"selectedOrder",true);var t=getObject(orders.pendingOrders[e].items,"productId",$("#productId").val());if(t){orders.pendingOrders[e].items.splice(t,1)}try{orders.validateItem();var n={productId:$("#productId").val(),productName:$("#product").val(),category:$("#category option:selected").text(),quantity:$("#quantity").val(),offerquantity:$("#offerquantity").val()};orders.pendingOrders[e].items.push(n);$("#productId").val("");$("#product").val("");$("#category").val("Category").change();$("#quantity").val("");$("#offerquantity").val("")}catch(r){navigator.notification.alert(r,callBackFunc,"Error");throw r}return false},finish:function(){try{orders.addItem();$.mobile.changePage("#saleOrderEntry",{transition:"slide",reverse:false,changeHash:true})}catch(e){return false}return false},saveOrder:function(){var e=getObject(orders.pendingOrders,"selectedOrder",true);if(orders.pendingOrders[e].items.length==0){navigator.notification.alert("No item to save",callBackFunc,"Error");return false}var t=orders.pendingOrders[e];t["date"]=Date.now();delete t["selectedOrder"];app.postData(t,"order",showNotice);orders.pendingOrders.splice(e,1);return false},selectCategory:function(){var e=$(this).find("option:selected").text();if(e=="Category"){orders.products=getObjects(Store.get("products."+Store.get("user").Userid),"pmCategory","")}else{orders.products=getObjects(Store.get("products."+Store.get("user").Userid),"pmCategory",e,"exact")}return false},searchProduct:function(){if($.trim($(this).val()).length==0){return false}var e=getObjects(orders.products,"pmProductName",$.trim($(this).val()));var t;$("#ui-results-products").children(".added").remove();$.each(e,function(e,n){if(e>=10){return false}t=$(".template:first",$("#ui-results-products")).clone().removeClass("template");$(".productName",t).html(n.pmProductName);$(".productCode",t).html(n.pmProductCode);$(".productId",t).val(n.pmProductId);$(t).addClass("added");$(t).appendTo("#ui-results-products")});$(".products").unbind("tap",orders.selectProduct).bind("tap",orders.selectProduct);return false},selectProduct:function(){var e=$(this).find("input.productId").val();var t=$(this).find("strong.productName").html();$("#product").val(t);$("#productId").val(e);$("#ui-results-products").children(".added").remove();$(this).blur();return false}}
